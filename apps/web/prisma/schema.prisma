// Prisma schema for Crypto Macro Overlay SaaS
// Uses Supabase PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==================== AUTH ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String?
  emailVerified DateTime? @map("email_verified")
  image         String?
  createdAt     DateTime  @default(now()) @map("created_at")
  lastLogin     DateTime? @map("last_login")

  // Relations
  subscription     Subscription?
  alertPreferences AlertPreferences?
  apiKeys          ApiKey[]
  webhooks         Webhook[]
  sessions         Session[]

  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ==================== SUBSCRIPTIONS ====================

enum SubscriptionTier {
  free
  starter
  pro
  institutional
}

enum SubscriptionStatus {
  active
  cancelled
  past_due
  trialing
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique @map("user_id")
  tier                 SubscriptionTier   @default(free)
  status               SubscriptionStatus @default(active)
  stripeCustomerId     String?            @map("stripe_customer_id")
  stripeSubscriptionId String?            @map("stripe_subscription_id")
  stripePriceId        String?            @map("stripe_price_id")
  currentPeriodStart   DateTime?          @map("current_period_start")
  currentPeriodEnd     DateTime?          @map("current_period_end")
  cancelAtPeriodEnd    Boolean            @default(false) @map("cancel_at_period_end")
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// ==================== ALERTS ====================

model AlertPreferences {
  id                  String   @id @default(cuid())
  userId              String   @unique @map("user_id")
  emailEnabled        Boolean  @default(true) @map("email_enabled")
  telegramEnabled     Boolean  @default(false) @map("telegram_enabled")
  telegramChatId      String?  @map("telegram_chat_id")
  discordWebhookUrl   String?  @map("discord_webhook_url")
  quadrantChanges     Boolean  @default(true) @map("quadrant_changes")
  signalChanges       Boolean  @default(true) @map("signal_changes")
  weeklySummary       Boolean  @default(true) @map("weekly_summary")
  dailyBriefing       Boolean  @default(false) @map("daily_briefing")
  riskAlerts          Boolean  @default(true) @map("risk_alerts")
  quietHoursEnabled   Boolean  @default(false) @map("quiet_hours_enabled")
  quietHoursStart     String?  @map("quiet_hours_start") // HH:MM format
  quietHoursEnd       String?  @map("quiet_hours_end")
  timezone            String   @default("UTC")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("alert_preferences")
}

// ==================== API ACCESS ====================

model ApiKey {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  keyHash   String    @map("key_hash")
  keyPrefix String    @map("key_prefix") // First 8 chars for identification
  name      String?
  lastUsed  DateTime? @map("last_used")
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

model Webhook {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  url          String
  secret       String
  events       String[]  // ['quadrant_change', 'signal_change', 'risk_alert']
  active       Boolean   @default(true)
  lastTriggered DateTime? @map("last_triggered")
  failureCount Int       @default(0) @map("failure_count")
  createdAt    DateTime  @default(now()) @map("created_at")

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs         WebhookLog[]

  @@map("webhooks")
}

model WebhookLog {
  id             String   @id @default(cuid())
  webhookId      String   @map("webhook_id")
  eventType      String   @map("event_type")
  payload        Json
  responseStatus Int?     @map("response_status")
  responseBody   String?  @map("response_body")
  createdAt      DateTime @default(now()) @map("created_at")

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@map("webhook_logs")
}

// ==================== SIGNALS ====================

model CurrentRegime {
  id                 String   @id @default(cuid())
  quadrant           String   // Q1, Q2, Q3, Q4
  primaryQuadrant    String   @map("primary_quadrant")
  secondaryQuadrant  String   @map("secondary_quadrant")
  growthDirection    String   @map("growth_direction") // rising, falling
  inflationDirection String   @map("inflation_direction")
  daysInRegime       Int      @default(1) @map("days_in_regime")
  lastChange         DateTime @map("last_change")
  confidence         Float    @default(0.8)
  timestamp          DateTime @default(now())
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@map("current_regime")
}

model CurrentSignal {
  id               String   @id @default(cuid())
  asset            String
  signal           String   // BULLISH, NEUTRAL, BEARISH
  targetAllocation Float    @map("target_allocation")
  conviction       String?  // high, medium, low
  category         String?  // core, high_beta, defi, l2, ai
  quadrant         String?  // Which quadrant this asset belongs to
  momentumScore    Float?   @map("momentum_score")
  volatilityRegime String?  @map("volatility_regime")
  previousSignal   String?  @map("previous_signal")
  signalChangedAt  DateTime? @map("signal_changed_at")
  timestamp        DateTime @default(now())
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@unique([asset])
  @@map("current_signals")
}

model SignalHistory {
  id            String   @id @default(cuid())
  timestamp     DateTime @default(now())
  eventType     String   @map("event_type") // quadrant_change, signal_change, regime_change
  asset         String?
  previousValue String?  @map("previous_value")
  newValue      String?  @map("new_value")
  reason        String?
  metadata      Json?
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([timestamp])
  @@index([asset])
  @@index([eventType])
  @@map("signal_history")
}

// ==================== RISK METRICS ====================

model RiskScore {
  id              String   @id @default(cuid())
  compositeScore  Int      @map("composite_score") // 0-100
  interpretation  String   // bullish, neutral, bearish
  exchangeFlows   Float?   @map("exchange_flows")
  stablecoinSupply Float?  @map("stablecoin_supply")
  fundingRates    Float?   @map("funding_rates")
  etfFlows        Float?   @map("etf_flows")
  timestamp       DateTime @default(now())
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("risk_scores")
}
